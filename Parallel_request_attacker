#!/usr/bin/env python3
import asyncio, aiohttp, ssl, time, argparse
from aiohttp import TCPConnector

# ----------  config  ----------
MAX_CONCURRENT   = 2048          # cap simultaneous sockets
POOL_LIMIT       = 0             # 0 = no global limit (semaphore is the real gate)
KEEPALIVE        = 30
SSL_CONTEXT      = ssl.create_default_context()
SSL_CONTEXT.check_hostname = False
SSL_CONTEXT.verify_mode    = ssl.CERT_NONE
# --------------------------------

async def bounded_fetch(session, url, payload, headers, sem, req_id):
    """Single async POST guarded by semaphore + connection-pool."""
    async with sem:
        start = time.time()
        try:
            async with session.post(url, json=payload, headers=headers,
                                    timeout=aiohttp.ClientTimeout(total=10)) as resp:
                text = await resp.text()
                elapsed = time.time() - start
                return {
                    "id": req_id,
                    "status": "âœ…" if resp.status < 400 else "âŒ",
                    "code": resp.status,
                    "text": text[:100],
                    "time": elapsed
                }
        except Exception as e:
            elapsed = time.time() - start
            return {
                "id": req_id,
                "status": "âŒ",
                "code": "Exception",
                "text": str(e),
                "time": elapsed
            }

async def run_async_requests(url, num_requests, payload, headers):
    """Fire N requests asynchronously, honouring MAX_CONCURRENT."""
    semaphore = asyncio.Semaphore(MAX_CONCURRENT)
    conn = TCPConnector(
        limit=POOL_LIMIT,
        limit_per_host=0,
        keepalive_timeout=KEEPALIVE,
        ssl=SSL_CONTEXT,
        enable_cleanup_closed=True
    )

    async with aiohttp.ClientSession(connector=conn) as session:
        tasks = [
            asyncio.create_task(
                bounded_fetch(session, url, payload, headers, semaphore, i)
            )
            for i in range(1, num_requests + 1)
        ]
        # gather keeps order; you can use as_completed if you prefer
        return await asyncio.gather(*tasks)

# ----------  CLI remains identical  ----------
if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="Parallel HTTP requester for load testing.")
    parser.add_argument("--url", required=True, help="The target URL for the POST request.")
    parser.add_argument("--requests", type=int, default=100, help="The number of parallel requests to send.")
    parser.add_argument("--cookies", required=True, help="The full string of cookies to include in the request header.")
    parser.add_argument("--xsrf_token", required=True, help="The X-XSRF-TOKEN to include in the request header.")
    args = parser.parse_args()

    headers = {
        "Content-Type": "application/json",
        "Accept": "application/json",
        "Origin": "",
        "Referer": "",
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.0.0 Safari/537.36",
        "X-XSRF-TOKEN": args.xsrf_token,
        "Cookie": args.cookies
    }

    payload = {
        "user_id": "",
        "user_name": "Sample_ukser",
        "role_type": "user"
    }

    print(f"Sending {args.requests} parallel requests to {args.url}...")
    responses = asyncio.run(run_async_requests(args.url, args.requests, payload, headers))

    success_count = sum(1 for r in responses if r["status"] == "âœ…")
    error_count   = len(responses) - success_count
    times         = [r["time"] for r in responses]
    avg_time      = sum(times) / len(times)
    min_time, max_time = min(times), max(times)

    print("\n--- Summary ---")
    print(f"âœ… Success: {success_count}")
    print(f"âŒ Errors: {error_count}")
    print(f"â±ï¸  Avg Response Time: {avg_time:.2f} sec")
    print(f"ðŸš€ Fastest: {min_time:.2f} sec")
    print(f"ðŸ¢ Slowest: {max_time:.2f} sec\n")

    for r in responses:
        print(f"{r['status']} Request {r['id']}: {r['code']} - {r['text']} ({r['time']:.2f} sec)")